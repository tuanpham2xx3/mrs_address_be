name: Webhook Deploy

on:
  push:
    branches: [ main, develop ]

jobs:
  deploy:
    name: Deploy via Webhook
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via Webhook
        run: |
          echo "üöÄ Starting webhook deployment..."
          
          # Create payload - single line format for stability
          PAYLOAD='{"ref":"${{ github.ref }}","repository":{"name":"${{ github.event.repository.name }}","full_name":"${{ github.repository }}","html_url":"${{ github.event.repository.html_url }}","clone_url":"${{ github.event.repository.clone_url }}","default_branch":"${{ github.event.repository.default_branch }}"},"pusher":{"name":"${{ github.event.pusher.name || github.actor }}","email":"${{ github.event.pusher.email || github.actor }}@users.noreply.github.com"},"head_commit":{"id":"${{ github.sha }}","message":"${{ github.event.head_commit.message || 'Manual deployment' }}","timestamp":"${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}","url":"${{ github.event.head_commit.url || github.event.repository.html_url }}/commit/${{ github.sha }}","author":{"name":"${{ github.event.head_commit.author.name || github.actor }}","email":"${{ github.event.head_commit.author.email || github.actor }}@users.noreply.github.com"}}}'
          
          echo "=== PAYLOAD ==="
          echo "$PAYLOAD"
          echo "==============="
          
          # Generate signature - Hard-coded values t·ª´ h∆∞·ªõng d·∫´n
          WEBHOOK_SECRET="du_an_cua_tuan"
          WEBHOOK_URL="https://webhook1.iceteadev.site/deploy"
          
          echo -n "$PAYLOAD" > payload.json
          SIGNATURE_HASH=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | cut -d' ' -f2)
          SIGNATURE="sha256=$SIGNATURE_HASH"
          
          echo "=== SENDING REQUEST ==="
          echo "URL: $WEBHOOK_URL"
          echo "Secret: $WEBHOOK_SECRET"
          echo "Signature: $SIGNATURE"
          echo "======================="
          
          # Send request v·ªõi ƒë·∫ßy ƒë·ªß headers theo h∆∞·ªõng d·∫´n
          DELIVERY_ID="github-actions-$(date +%s)"
          RESPONSE=$(curl -w "\n%{http_code}" -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -H "X-Hub-Signature-256: $SIGNATURE" \
            -H "X-GitHub-Event: push" \
            -H "X-GitHub-Delivery: $DELIVERY_ID" \
            -H "User-Agent: GitHub-Hookshot/actions" \
            -d "$PAYLOAD")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "=== RESPONSE ==="
          echo "Status: $HTTP_CODE"
          echo "Body: $BODY"
          echo "================"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi 